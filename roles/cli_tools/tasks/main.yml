---
- name: Select macos package
  when: ansible_system == "Darwin"
  ansible.builtin.set_fact:
    cli_tools_packages: "{{ cli_tools_brew_packages }}"

- name: Install epel-release
  when:
    - ansible_system == "Linux"
    - ansible_distribution == "CentOS"
  ansible.builtin.package:
    name: epel-release
    state: latest
  become: true

- name: Select linux package
  when: ansible_system == "Linux"
  ansible.builtin.set_fact:
    cli_tools_packages: "{{ cli_tools_linux_packages }}"

- name: Install cli tools
  ansible.builtin.package:
    name: "{{ item }}"
    state: latest
  become: "{{ ansible_system == 'Linux' }}"
  loop: "{{ cli_tools_packages }}"

- name: Get XDG_CONFIG_HOME
  set_fact:
    xdg_config_home: "{{ lookup('env', 'XDG_CONFIG_HOME') | default((lookup('env', 'HOME'), '.config') | path_join, True) }}"

- name: Copy custom configuration to xdg_config_home
  ansible.builtin.copy:
    src: "./files/xdg_config_home/"  # trailing / is important to copy only directory content and not the directory itself
    dest: "{{ xdg_config_home }}"
    mode: 0644

- name: Manage configuration file
  when: cli_tools_shell_config_file != ""
  block:
    - name: Check config files exists
      ansible.builtin.stat:
        path: "{{ cli_tools_shell_config_file }}"
      register: file_details

    - name: Ensure config files exists
      when: not file_details.stat.exists
      ansible.builtin.file:
        path: "{{ cli_tools_shell_config_file }}"
        state: touch
        mode: 0600

    - name: Create config file
      ansible.builtin.blockinfile:
        marker: "# {mark} - cli-tools - ANSIBLE MANAGED BLOCK"
        insertafter: EOF
        path: "{{ cli_tools_shell_config_file }}"
        block: |
          if command -v exa &>/dev/null; then
            # Override common ls aliases whith exa (https://the.exa.website/) if available
            alias ls='exa'
            alias l='exa -lbF --git'
            alias la='exa -lbhHigUmuSa --time-style=long-iso --git --color-scale'
            alias ll='exa -lah'
            alias lt='exa --tree --level=2'
          else
            # Override common ls aliases
            alias ls='ls -G'
            alias l='ls -lFh'
            alias la='ls -lAFhp'
            alias ll='ls -lAhp'
            alias lr='ls -tRFh'
            alias lt='ls -ltFh'
          fi

          ##########
          ## Fuzzy Finder
          ##########
          if command -v fzf &>/dev/null; then
            # Auto-completion
            [[ $- == *i* ]] && source "/usr/local/opt/fzf/shell/completion.zsh" 2> /dev/null

            # Key bindings
            source "/usr/local/opt/fzf/shell/key-bindings.zsh"

            export FZF_COMPLETION_TRIGGER='~~'
            export FZF_DEFAULT_OPTS='--multi --height 50% --layout=reverse --border'
            # Use The silver searcher and enable hidden files
            if command -v ag &>/dev/null; then
              export FZF_DEFAULT_COMMAND='ag --hidden --ignore .git -g ""'
            fi
            if command -v bat &>/dev/null; then
              alias fzfp='fzf --preview "bat --style=numbers --color=always --line-range :500 {}"'
            else
              alias fzfp='fzf --preview "cat {}"'
            fi
          fi

          ##########
          ## zoxide, smarter cd command
          ##########
          if command -v zoxide &>/dev/null; then
            eval "$(zoxide init zsh)"
          fi

          ##########
          ## CURL
          ##########
          export CURL_HOME={{ xdg_config_home }}/curl
          # Use brew installed CURL instead of MacOS default's one
          if command -v brew &>/dev/null; then
            export PATH="$(brew --prefix)/opt/curl/bin:${PATH}"
          fi
