---

- name: Ansible check ssh directory exists
  stat:
    path: "{{ ssh_config_dir }}"
  register: directory_details

- name: Ensure ssh directory exists
  when: not (directory_details.stat.exists and directory_details.stat.isdir)
  file:
    path: "{{ ssh_config_dir }}"
    state: directory
    mode: 0700

- name: Ansible check config files exists
  stat:
    path: "{{ ssh_config_file }}"
  register: file_details

- name: Ensure config files exists
  when: not file_details.stat.exists
  file:
    path: "{{ ssh_config_file }}"
    state: touch
    mode: 0600

- name: Add default SSH config
  blockinfile:
    marker: "# {mark} - SSH - ANSIBLE MANAGED BLOCK"
    insertafter: EOF
    path: "{{ ssh_config_file }}"
    block: |
      # # Add a github account using another ssh key
      # # Ex: git clone git@github-personal-account:bsemp/workstation-bootstrap.git
      # Host github-personal-account
      #   HostName github.com
      #   User git
      #   PreferredAuthentications publickey
      #   IdentityFile /Users/bsemperlotti/.ssh/github_personal_account
      #   IdentitiesOnly yes

      # Add default github config
      Host github.com
        User git
        PreferredAuthentications publickey

      # Host * should always be the last entry has it is the most general matching rule
      Host *
        AddKeysToAgent yes
        UseKeychain yes
        ForwardAgent no
        Compression yes
